# 电商网站数据库迁移方案文档

## 1. 项目概述

本文档详细描述了将前端网站的所有模拟数据迁移到Supabase数据库系统的完整方案，包括商品数据、订单数据、用户数据、商品分类数据和网站内容数据的迁移策略。

### 1.1 迁移目标
- 将mockData.ts中的所有模拟数据迁移到Supabase数据库
- 建立完整的数据关联关系和约束
- 实现数据的实时同步更新
- 确保数据完整性和一致性
- 优化查询性能和索引设计

### 1.2 涉及数据范围
- **商品数据**：产品信息、分类、规格、图片、评价
- **订单数据**：订单信息、订单商品、支付状态、物流信息
- **用户数据**：用户基础信息、收货地址、优惠券
- **网站内容**：About、Contact、Help、Shipping、Returns、Privacy、Terms页面内容

## 2. 现有数据分析

### 2.1 商品相关数据结构

#### 商品基础信息 (mockProductDetails)
```typescript
interface ProductDetail {
  id: string;                    // 商品ID
  name: string;                  // 商品名称
  description: string;           // 商品描述
  detailed_description: string;  // 详细描述(HTML)
  price: number;                 // 价格
  category_id: string;           // 分类ID
  images: string[];              // 商品图片
  gallery_images: string[];      // 画廊图片
  specifications: object;        // 商品规格
  reviews: Review[];             // 商品评价
  rating: number;                // 平均评分
  review_count: number;          // 评价数量
  related_products: string[];    // 相关商品
  is_active: boolean;            // 是否激活
  stock_quantity: number;        // 库存数量
  created_at: string;            // 创建时间
  updated_at: string;            // 更新时间
}
```

#### 商品分类信息 (mockCategories)
```typescript
interface Category {
  id: string;                    // 分类ID
  name: string;                  // 分类名称
  slug: string;                  // URL别名
  description: string;           // 分类描述
  image_url: string;             // 分类图片
  icon: string;                  // 图标
  color: string;                 // 主题色
  product_count: number;         // 商品数量
  is_featured: boolean;          // 是否推荐
  sort_order: number;            // 排序
  tags: string[];                // 标签
  parent_id?: string;            // 父分类ID
  subcategories?: Category[];    // 子分类
  created_at: string;            // 创建时间
  updated_at: string;            // 更新时间
}
```

### 2.2 订单相关数据结构

#### 订单信息 (mockOrders)
```typescript
interface Order {
  id: string;                    // 订单ID
  user_id: string;               // 用户ID
  total_amount: number;          // 订单总金额
  status: string;                // 订单状态
  shipping_address: ShippingAddress; // 收货地址
  payment_method: string;        // 支付方式
  payment_status: string;        // 支付状态
  items: OrderItem[];            // 订单商品
  created_at: string;            // 创建时间
  updated_at: string;            // 更新时间
}
```

### 2.3 用户相关数据结构

#### 用户基础信息 (mockUsers)
```typescript
interface User {
  id: string;                    // 用户ID
  email: string;                 // 邮箱
  full_name: string;             // 全名
  username: string;              // 用户名
  phone: string;                 // 手机号
  avatar_url: string;            // 头像URL
  balance: number;               // 账户余额
  created_at: string;            // 创建时间
  updated_at: string;            // 更新时间
}
```

## 3. 数据库表设计

### 3.1 商品相关表

#### products 表 - 商品基础信息
```sql
CREATE TABLE products (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE NOT NULL,
    description TEXT,
    detailed_description TEXT,
    price DECIMAL(10,2) NOT NULL,
    category_id UUID REFERENCES product_categories(id),
    is_active BOOLEAN DEFAULT true,
    is_featured BOOLEAN DEFAULT false,
    stock_quantity INTEGER DEFAULT 0,
    rating DECIMAL(3,2) DEFAULT 0,
    review_count INTEGER DEFAULT 0,
    sort_order INTEGER DEFAULT 0,
    seo_title VARCHAR(255),
    seo_description TEXT,
    seo_keywords TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### product_categories 表 - 商品分类
```sql
CREATE TABLE product_categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE NOT NULL,
    description TEXT,
    image_url TEXT,
    icon VARCHAR(50),
    color VARCHAR(7),
    parent_id UUID REFERENCES product_categories(id),
    is_featured BOOLEAN DEFAULT false,
    sort_order INTEGER DEFAULT 0,
    product_count INTEGER DEFAULT 0,
    tags TEXT[],
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### product_images 表 - 商品图片
```sql
CREATE TABLE product_images (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    image_url TEXT NOT NULL,
    alt_text VARCHAR(255),
    is_primary BOOLEAN DEFAULT false,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### product_specifications 表 - 商品规格
```sql
CREATE TABLE product_specifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    spec_name VARCHAR(100) NOT NULL,
    spec_value TEXT NOT NULL,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### product_reviews 表 - 商品评价
```sql
CREATE TABLE product_reviews (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    user_id UUID REFERENCES frontend_users(id) ON DELETE SET NULL,
    user_name VARCHAR(100) NOT NULL,
    user_avatar TEXT,
    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    images TEXT[],
    is_verified BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 3.2 订单相关表

#### orders 表 - 订单信息
```sql
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_number VARCHAR(50) UNIQUE NOT NULL,
    user_id UUID NOT NULL REFERENCES frontend_users(id),
    total_amount DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    shipping_fee DECIMAL(10,2) DEFAULT 0,
    tax_amount DECIMAL(10,2) DEFAULT 0,
    status VARCHAR(20) NOT NULL DEFAULT 'pending' 
        CHECK (status IN ('pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled', 'refunded')),
    payment_method VARCHAR(50),
    payment_status VARCHAR(20) DEFAULT 'pending'
        CHECK (payment_status IN ('pending', 'paid', 'failed', 'refunded', 'partial_refund')),
    payment_id VARCHAR(255),
    coupon_code VARCHAR(50),
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### order_items 表 - 订单商品
```sql
CREATE TABLE order_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    product_id UUID NOT NULL REFERENCES products(id),
    product_name VARCHAR(255) NOT NULL,
    product_image TEXT,
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    unit_price DECIMAL(10,2) NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    specifications JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### shipping_addresses 表 - 收货地址
```sql
CREATE TABLE shipping_addresses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES frontend_users(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    province VARCHAR(50) NOT NULL,
    city VARCHAR(50) NOT NULL,
    district VARCHAR(50) NOT NULL,
    address TEXT NOT NULL,
    postal_code VARCHAR(20),
    is_default BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### order_shipping 表 - 订单物流
```sql
CREATE TABLE order_shipping (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    shipping_address_id UUID REFERENCES shipping_addresses(id),
    recipient_name VARCHAR(100) NOT NULL,
    recipient_phone VARCHAR(20) NOT NULL,
    shipping_address TEXT NOT NULL,
    carrier VARCHAR(50),
    tracking_number VARCHAR(100),
    shipping_method VARCHAR(50),
    shipping_fee DECIMAL(10,2) DEFAULT 0,
    estimated_delivery DATE,
    actual_delivery TIMESTAMP WITH TIME ZONE,
    status VARCHAR(20) DEFAULT 'pending'
        CHECK (status IN ('pending', 'picked_up', 'in_transit', 'out_for_delivery', 'delivered', 'failed')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 3.3 优惠券相关表

#### coupons 表 - 优惠券
```sql
CREATE TABLE coupons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    type VARCHAR(20) NOT NULL CHECK (type IN ('percentage', 'fixed_amount')),
    value DECIMAL(10,2) NOT NULL,
    min_order_amount DECIMAL(10,2) DEFAULT 0,
    max_discount_amount DECIMAL(10,2),
    usage_limit INTEGER,
    used_count INTEGER DEFAULT 0,
    valid_from TIMESTAMP WITH TIME ZONE NOT NULL,
    valid_until TIMESTAMP WITH TIME ZONE NOT NULL,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### user_coupons 表 - 用户优惠券
```sql
CREATE TABLE user_coupons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES frontend_users(id) ON DELETE CASCADE,
    coupon_id UUID NOT NULL REFERENCES coupons(id) ON DELETE CASCADE,
    used_at TIMESTAMP WITH TIME ZONE,
    order_id UUID REFERENCES orders(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user_id, coupon_id)
);
```

### 3.4 网站内容表

#### website_content 表 - 网站内容页面
```sql
CREATE TABLE website_content (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    page_key VARCHAR(50) UNIQUE NOT NULL,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    meta_title VARCHAR(255),
    meta_description TEXT,
    meta_keywords TEXT,
    is_published BOOLEAN DEFAULT true,
    version INTEGER DEFAULT 1,
    author_id UUID REFERENCES frontend_users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## 4. 索引设计

### 4.1 主要索引
```sql
-- 商品表索引
CREATE INDEX idx_products_category_id ON products(category_id);
CREATE INDEX idx_products_is_active ON products(is_active);
CREATE INDEX idx_products_is_featured ON products(is_featured);
CREATE INDEX idx_products_price ON products(price);
CREATE INDEX idx_products_rating ON products(rating DESC);
CREATE INDEX idx_products_created_at ON products(created_at DESC);

-- 商品分类索引
CREATE INDEX idx_product_categories_parent_id ON product_categories(parent_id);
CREATE INDEX idx_product_categories_slug ON product_categories(slug);
CREATE INDEX idx_product_categories_sort_order ON product_categories(sort_order);

-- 订单表索引
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_payment_status ON orders(payment_status);
CREATE INDEX idx_orders_created_at ON orders(created_at DESC);
CREATE INDEX idx_orders_order_number ON orders(order_number);

-- 订单商品索引
CREATE INDEX idx_order_items_order_id ON order_items(order_id);
CREATE INDEX idx_order_items_product_id ON order_items(product_id);

-- 商品评价索引
CREATE INDEX idx_product_reviews_product_id ON product_reviews(product_id);
CREATE INDEX idx_product_reviews_user_id ON product_reviews(user_id);
CREATE INDEX idx_product_reviews_rating ON product_reviews(rating);
CREATE INDEX idx_product_reviews_created_at ON product_reviews(created_at DESC);

-- 收货地址索引
CREATE INDEX idx_shipping_addresses_user_id ON shipping_addresses(user_id);
CREATE INDEX idx_shipping_addresses_is_default ON shipping_addresses(is_default);
```

## 5. RLS安全策略

### 5.1 商品相关表的RLS策略
```sql
-- 启用RLS
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE product_categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE product_images ENABLE ROW LEVEL SECURITY;
ALTER TABLE product_specifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE product_reviews ENABLE ROW LEVEL SECURITY;

-- 商品表策略
CREATE POLICY "Products are viewable by everyone" ON products
    FOR SELECT USING (is_active = true);

CREATE POLICY "Products are manageable by authenticated users" ON products
    FOR ALL USING (auth.role() = 'authenticated');

-- 商品分类策略
CREATE POLICY "Categories are viewable by everyone" ON product_categories
    FOR SELECT USING (true);

CREATE POLICY "Categories are manageable by authenticated users" ON product_categories
    FOR ALL USING (auth.role() = 'authenticated');

-- 商品评价策略
CREATE POLICY "Reviews are viewable by everyone" ON product_reviews
    FOR SELECT USING (true);

CREATE POLICY "Users can manage their own reviews" ON product_reviews
    FOR ALL USING (auth.uid() = user_id);
```

### 5.2 订单相关表的RLS策略
```sql
-- 启用RLS
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE order_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE shipping_addresses ENABLE ROW LEVEL SECURITY;

-- 订单表策略
CREATE POLICY "Users can view their own orders" ON orders
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can manage their own orders" ON orders
    FOR ALL USING (auth.uid() = user_id);

-- 收货地址策略
CREATE POLICY "Users can manage their own addresses" ON shipping_addresses
    FOR ALL USING (auth.uid() = user_id);
```

## 6. 数据迁移策略

### 6.1 迁移步骤

#### 第一阶段：基础表结构创建
1. 创建商品分类表并插入数据
2. 创建商品基础表
3. 创建商品图片、规格、评价表
4. 创建订单相关表
5. 创建优惠券表
6. 创建网站内容表

#### 第二阶段：数据迁移
1. 迁移商品分类数据
2. 迁移商品基础数据
3. 迁移商品图片和规格数据
4. 迁移商品评价数据
5. 迁移订单数据
6. 迁移优惠券数据
7. 迁移网站内容数据

#### 第三阶段：数据验证和优化
1. 验证数据完整性
2. 检查外键约束
3. 优化查询性能
4. 测试RLS策略

### 6.2 数据转换规则

#### 商品数据转换
```sql
-- 商品分类数据插入
INSERT INTO product_categories (id, name, slug, description, image_url, icon, color, parent_id, is_featured, sort_order, product_count, tags)
SELECT 
    id,
    name,
    slug,
    description,
    image_url,
    icon,
    color,
    parent_id,
    is_featured,
    sort_order,
    product_count,
    tags
FROM mockCategories;

-- 商品基础数据插入
INSERT INTO products (id, name, slug, description, detailed_description, price, category_id, is_active, stock_quantity, rating, review_count)
SELECT 
    id,
    name,
    LOWER(REPLACE(name, ' ', '-')) as slug,
    description,
    detailed_description,
    price,
    category_id,
    is_active,
    stock_quantity,
    rating,
    review_count
FROM mockProductDetails;
```

#### 网站内容数据转换
```sql
-- 网站内容页面数据
INSERT INTO website_content (page_key, title, content, is_published) VALUES
('about', '关于我们', '<!-- About页面内容 -->', true),
('contact', '联系我们', '<!-- Contact页面内容 -->', true),
('help', '帮助中心', '<!-- Help页面内容 -->', true),
('shipping', '配送说明', '<!-- Shipping页面内容 -->', true),
('returns', '退换货政策', '<!-- Returns页面内容 -->', true),
('privacy', '隐私政策', '<!-- Privacy页面内容 -->', true),
('terms', '服务条款', '<!-- Terms页面内容 -->', true);
```

## 7. 实时同步机制

### 7.1 触发器设计
```sql
-- 更新时间触发器函数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- 为相关表添加更新时间触发器
CREATE TRIGGER update_products_updated_at 
    BEFORE UPDATE ON products 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_orders_updated_at 
    BEFORE UPDATE ON orders 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();
```

### 7.2 实时订阅配置
```typescript
// 前端实时订阅配置
const subscribeToProducts = () => {
  return supabase
    .channel('products')
    .on('postgres_changes', 
        { event: '*', schema: 'public', table: 'products' },
        (payload) => {
          // 处理商品数据变更
          handleProductChange(payload);
        }
    )
    .subscribe();
};

const subscribeToOrders = () => {
  return supabase
    .channel('orders')
    .on('postgres_changes',
        { event: '*', schema: 'public', table: 'orders' },
        (payload) => {
          // 处理订单数据变更
          handleOrderChange(payload);
        }
    )
    .subscribe();
};
```

## 8. 性能优化建议

### 8.1 查询优化
- 使用适当的索引提高查询性能
- 对大表进行分页查询
- 使用视图简化复杂查询
- 定期分析查询计划并优化

### 8.2 缓存策略
- 对商品分类等相对静态的数据进行缓存
- 使用Redis缓存热门商品数据
- 实现查询结果缓存机制

### 8.3 数据库维护
- 定期更新表统计信息
- 监控数据库性能指标
- 定期备份重要数据
- 清理过期的日志数据

## 9. 迁移时间计划

### 9.1 预计时间安排
- **第一阶段**（1-2天）：数据库表结构设计和创建
- **第二阶段**（2-3天）：数据迁移脚本开发和执行
- **第三阶段**（1-2天）：数据验证和性能优化
- **第四阶段**（1天）：前端代码适配和测试

### 9.2 风险控制
- 在迁移前进行完整的数据备份
- 分阶段进行迁移，每个阶段都进行验证
- 准备回滚方案以应对意外情况
- 在测试环境中先进行完整的迁移测试

## 10. 验收标准

### 10.1 数据完整性验证
- 所有模拟数据成功迁移到数据库
- 数据关联关系正确建立
- 外键约束正常工作
- RLS策略正确配置

### 10.2 功能验证
- 前端页面正常显示数据库数据
- 商品搜索和筛选功能正常
- 订单创建和管理功能正常
- 用户管理功能正常
- 网站内容页面正常显示

### 10.3 性能验证
- 页面加载时间在可接受范围内
- 数据库查询响应时间正常
- 实时同步功能正常工作
- 并发访问性能满足要求

通过以上完整的迁移方案，可以确保前端网站的所有数据成功迁移到Supabase数据库系统，并建立完整的数据关联关系和实时同步机制。