name: å¤‡ä»½çŠ¶æ€ç›‘æŽ§

on:
  schedule:
    # æ¯å¤©æ£€æŸ¥å¤‡ä»½çŠ¶æ€
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  monitor-backup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      issues: write
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ£€æŸ¥æœ€è¿‘å¤‡ä»½çŠ¶æ€
      id: check-backup
      run: |
        # èŽ·å–æœ€è¿‘çš„å¤‡ä»½å·¥ä½œæµè¿è¡ŒçŠ¶æ€
        BACKUP_STATUS=$(gh api repos/${{ github.repository }}/actions/workflows/backup.yml/runs --jq '.workflow_runs[0].conclusion' || echo "unknown")
        BACKUP_DATE=$(gh api repos/${{ github.repository }}/actions/workflows/backup.yml/runs --jq '.workflow_runs[0].created_at' || echo "unknown")
        
        echo "backup_status=$BACKUP_STATUS" >> $GITHUB_OUTPUT
        echo "backup_date=$BACKUP_DATE" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥å¤‡ä»½åˆ†æ”¯
        BACKUP_BRANCHES=$(git ls-remote --heads origin | grep backup- | wc -l)
        echo "backup_branches=$BACKUP_BRANCHES" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æœ€æ–°å¤‡ä»½åˆ†æ”¯æ—¥æœŸ
        LATEST_BACKUP=$(git ls-remote --heads origin | grep backup- | sort | tail -1 | sed 's/.*backup-//')
        echo "latest_backup=$LATEST_BACKUP" >> $GITHUB_OUTPUT
        
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ç”Ÿæˆç›‘æŽ§æŠ¥å‘Š
      run: |
        echo "# å¤‡ä»½çŠ¶æ€ç›‘æŽ§æŠ¥å‘Š" > backup-report.md
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> backup-report.md
        echo "" >> backup-report.md
        
        echo "## å¤‡ä»½å·¥ä½œæµçŠ¶æ€" >> backup-report.md
        echo "- æœ€è¿‘å¤‡ä»½çŠ¶æ€: ${{ steps.check-backup.outputs.backup_status }}" >> backup-report.md
        echo "- æœ€è¿‘å¤‡ä»½æ—¶é—´: ${{ steps.check-backup.outputs.backup_date }}" >> backup-report.md
        echo "" >> backup-report.md
        
        echo "## å¤‡ä»½åˆ†æ”¯ç»Ÿè®¡" >> backup-report.md
        echo "- å¤‡ä»½åˆ†æ”¯æ€»æ•°: ${{ steps.check-backup.outputs.backup_branches }}" >> backup-report.md
        echo "- æœ€æ–°å¤‡ä»½åˆ†æ”¯: backup-${{ steps.check-backup.outputs.latest_backup }}" >> backup-report.md
        echo "" >> backup-report.md
        
        # æ£€æŸ¥å¤‡ä»½å¥åº·çŠ¶æ€
        if [ "${{ steps.check-backup.outputs.backup_status }}" = "success" ]; then
          echo "## å¥åº·çŠ¶æ€: âœ… æ­£å¸¸" >> backup-report.md
        elif [ "${{ steps.check-backup.outputs.backup_status }}" = "failure" ]; then
          echo "## å¥åº·çŠ¶æ€: âŒ å¼‚å¸¸" >> backup-report.md
          echo "æœ€è¿‘å¤‡ä»½å¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥å¤‡ä»½å·¥ä½œæµ" >> backup-report.md
        else
          echo "## å¥åº·çŠ¶æ€: âš ï¸ æœªçŸ¥" >> backup-report.md
          echo "æ— æ³•èŽ·å–å¤‡ä»½çŠ¶æ€ä¿¡æ¯" >> backup-report.md
        fi
        
    - name: åˆ›å»ºé—®é¢˜æŠ¥å‘Š (å¦‚æžœå¤‡ä»½å¤±è´¥)
      if: steps.check-backup.outputs.backup_status == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const title = `ðŸš¨ å¤‡ä»½å¤±è´¥è­¦æŠ¥ - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## å¤‡ä»½å¤±è´¥é€šçŸ¥
          
          **æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
          **çŠ¶æ€**: å¤‡ä»½å·¥ä½œæµæ‰§è¡Œå¤±è´¥
          **æœ€è¿‘å¤‡ä»½æ—¶é—´**: ${{ steps.check-backup.outputs.backup_date }}
          
          ### éœ€è¦æ£€æŸ¥çš„é¡¹ç›®
          - [ ] æ£€æŸ¥å¤‡ä»½å·¥ä½œæµæ—¥å¿—
          - [ ] éªŒè¯ GitHub Actions æƒé™
          - [ ] æ£€æŸ¥å­˜å‚¨ç©ºé—´
          - [ ] éªŒè¯ä¾èµ–å®‰è£…
          
          ### ç›¸å…³é“¾æŽ¥
          - [å¤‡ä»½å·¥ä½œæµ](https://github.com/${{ github.repository }}/actions/workflows/backup.yml)
          - [æœ€è¿‘è¿è¡Œè®°å½•](https://github.com/${{ github.repository }}/actions)
          
          ---
          *æ­¤é—®é¢˜ç”±å¤‡ä»½ç›‘æŽ§ç³»ç»Ÿè‡ªåŠ¨åˆ›å»º*
          `;
          
          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„é—®é¢˜
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['backup-alert']
          });
          
          const hasExistingAlert = existingIssues.data.some(issue => 
            issue.title.includes('å¤‡ä»½å¤±è´¥è­¦æŠ¥')
          );
          
          if (!hasExistingAlert) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['backup-alert', 'bug', 'high-priority']
            });
          }
          
    - name: ä¸Šä¼ ç›‘æŽ§æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: backup-monitor-report-${{ github.run_number }}
        path: backup-report.md
        retention-days: 30