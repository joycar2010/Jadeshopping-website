# 玉石雅韵电商平台后台管理系统技术架构文档

## 1. 架构设计

```mermaid
graph TD
    A[管理员浏览器] --> B[React Admin Dashboard]
    B --> C[Express.js Backend API]
    C --> D[MySQL Database]
    C --> E[Redis Cache]
    C --> F[File Storage Service]
    
    G[前端用户] --> H[React Frontend App]
    H --> C
    
    C --> I[第三方服务]
    I --> J[支付接口]
    I --> K[物流API]
    I --> L[短信服务]
    I --> M[邮件服务]

    subgraph "后台管理层"
        B
    end

    subgraph "API服务层"
        C
        E
    end

    subgraph "数据存储层"
        D
        F
    end

    subgraph "外部服务层"
        I
        J
        K
        L
        M
    end
```

## 2. 技术描述

- **前端管理界面**：React@18 + TypeScript + Ant Design + Vite
- **前端用户界面**：React@18 + TypeScript + Tailwind CSS + Vite
- **后端API服务**：Express.js@4 + TypeScript + JWT认证
- **数据库**：MySQL@8.0 + Prisma ORM
- **缓存系统**：Redis@7.0
- **文件存储**：本地存储 + 云存储（可选）
- **部署方案**：Docker + Docker Compose

## 3. 路由定义

### 3.1 后台管理系统路由

| 路由 | 用途 |
|------|------|
| /admin | 后台管理系统首页，重定向到仪表板 |
| /admin/login | 管理员登录页面 |
| /admin/dashboard | 仪表板页面，显示核心数据和统计 |
| /admin/products | 商品管理页面，商品列表和操作 |
| /admin/products/create | 新增商品页面 |
| /admin/products/:id/edit | 编辑商品页面 |
| /admin/categories | 分类管理页面 |
| /admin/orders | 订单管理页面 |
| /admin/orders/:id | 订单详情页面 |
| /admin/users | 用户管理页面 |
| /admin/users/:id | 用户详情页面 |
| /admin/reviews | 评价管理页面 |
| /admin/marketing | 营销管理页面 |
| /admin/analytics | 数据分析页面 |
| /admin/settings | 系统设置页面 |
| /admin/logs | 操作日志页面 |

### 3.2 前端用户系统路由（现有）

| 路由 | 用途 |
|------|------|
| / | 首页，商品展示和导航 |
| /products | 商品列表页面 |
| /products/:id | 商品详情页面 |
| /cart | 购物车页面 |
| /checkout | 结算页面 |
| /orders | 用户订单页面 |
| /profile | 用户个人中心页面 |
| /login | 用户登录页面 |

## 4. API定义

### 4.1 认证相关API

**管理员登录**
```
POST /api/admin/auth/login
```

请求参数：
| 参数名 | 参数类型 | 是否必需 | 描述 |
|--------|----------|----------|------|
| username | string | true | 管理员用户名 |
| password | string | true | 密码 |

响应数据：
| 参数名 | 参数类型 | 描述 |
|--------|----------|------|
| success | boolean | 登录是否成功 |
| token | string | JWT访问令牌 |
| user | AdminUser | 管理员用户信息 |

示例：
```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "admin1",
    "username": "admin",
    "name": "系统管理员",
    "role": "super_admin",
    "permissions": ["*"]
  }
}
```

### 4.2 商品管理API

**获取商品列表**
```
GET /api/admin/products
```

请求参数：
| 参数名 | 参数类型 | 是否必需 | 描述 |
|--------|----------|----------|------|
| page | number | false | 页码，默认1 |
| limit | number | false | 每页数量，默认20 |
| category | string | false | 分类筛选 |
| search | string | false | 搜索关键词 |
| status | string | false | 商品状态筛选 |

**创建商品**
```
POST /api/admin/products
```

**更新商品**
```
PUT /api/admin/products/:id
```

**删除商品**
```
DELETE /api/admin/products/:id
```

### 4.3 订单管理API

**获取订单列表**
```
GET /api/admin/orders
```

**更新订单状态**
```
PUT /api/admin/orders/:id/status
```

**获取订单详情**
```
GET /api/admin/orders/:id
```

### 4.4 用户管理API

**获取用户列表**
```
GET /api/admin/users
```

**获取用户详情**
```
GET /api/admin/users/:id
```

**更新用户状态**
```
PUT /api/admin/users/:id/status
```

### 4.5 数据统计API

**获取仪表板数据**
```
GET /api/admin/dashboard/stats
```

**获取销售报表**
```
GET /api/admin/analytics/sales
```

**获取用户分析数据**
```
GET /api/admin/analytics/users
```

## 5. 服务器架构图

```mermaid
graph TD
    A[Nginx 反向代理] --> B[Express.js 应用服务器]
    B --> C[认证中间件]
    C --> D[权限验证中间件]
    D --> E[业务逻辑层]
    
    E --> F[商品服务]
    E --> G[订单服务]
    E --> H[用户服务]
    E --> I[统计服务]
    
    F --> J[Prisma ORM]
    G --> J
    H --> J
    I --> J
    
    J --> K[(MySQL 数据库)]
    
    B --> L[Redis 缓存]
    B --> M[文件上传服务]
    
    subgraph "应用层"
        B
        C
        D
    end
    
    subgraph "业务层"
        E
        F
        G
        H
        I
    end
    
    subgraph "数据层"
        J
        K
        L
        M
    end
```

## 6. 数据模型

### 6.1 数据模型定义

**管理员用户表 (admin_users)**
```sql
CREATE TABLE admin_users (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    role ENUM('super_admin', 'admin', 'operator', 'analyst') DEFAULT 'operator',
    status ENUM('active', 'inactive', 'suspended') DEFAULT 'active',
    last_login_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**权限表 (permissions)**
```sql
CREATE TABLE permissions (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    name VARCHAR(100) NOT NULL,
    code VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    module VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**角色权限关联表 (role_permissions)**
```sql
CREATE TABLE role_permissions (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    role VARCHAR(50) NOT NULL,
    permission_code VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (permission_code) REFERENCES permissions(code)
);
```

### 6.2 核心业务表

**商品表 (products)**
```sql
CREATE TABLE products (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    original_price DECIMAL(10,2),
    category_id VARCHAR(36) NOT NULL,
    rating DECIMAL(3,2) DEFAULT 0,
    review_count INT DEFAULT 0,
    sales INT DEFAULT 0,
    stock INT DEFAULT 0,
    status ENUM('active', 'inactive', 'out_of_stock') DEFAULT 'active',
    specifications JSON,
    tags JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES categories(id)
);
```

**商品图片表 (product_images)**
```sql
CREATE TABLE product_images (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    product_id VARCHAR(36) NOT NULL,
    image_url VARCHAR(500) NOT NULL,
    alt_text VARCHAR(255),
    sort_order INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
);
```

**分类表 (categories)**
```sql
CREATE TABLE categories (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    image_url VARCHAR(500),
    parent_id VARCHAR(36) NULL,
    sort_order INT DEFAULT 0,
    status ENUM('active', 'inactive') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (parent_id) REFERENCES categories(id)
);
```

**用户表 (users)**
```sql
CREATE TABLE users (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100),
    phone VARCHAR(20),
    avatar_url VARCHAR(500),
    birthday DATE,
    gender ENUM('male', 'female', 'other'),
    status ENUM('active', 'inactive', 'suspended') DEFAULT 'active',
    member_level ENUM('bronze', 'silver', 'gold', 'diamond') DEFAULT 'bronze',
    points INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**订单表 (orders)**
```sql
CREATE TABLE orders (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    order_number VARCHAR(50) UNIQUE NOT NULL,
    user_id VARCHAR(36) NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    status ENUM('pending', 'paid', 'shipped', 'delivered', 'cancelled', 'refunded') DEFAULT 'pending',
    payment_method VARCHAR(50),
    payment_status ENUM('pending', 'paid', 'failed', 'refunded') DEFAULT 'pending',
    shipping_address JSON NOT NULL,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

**订单项表 (order_items)**
```sql
CREATE TABLE order_items (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    order_id VARCHAR(36) NOT NULL,
    product_id VARCHAR(36) NOT NULL,
    product_name VARCHAR(255) NOT NULL,
    product_image VARCHAR(500),
    price DECIMAL(10,2) NOT NULL,
    quantity INT NOT NULL,
    specifications JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id)
);
```

**评价表 (reviews)**
```sql
CREATE TABLE reviews (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    product_id VARCHAR(36) NOT NULL,
    user_id VARCHAR(36) NOT NULL,
    order_id VARCHAR(36),
    rating INT NOT NULL CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (product_id) REFERENCES products(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (order_id) REFERENCES orders(id)
);
```

**评价图片表 (review_images)**
```sql
CREATE TABLE review_images (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    review_id VARCHAR(36) NOT NULL,
    image_url VARCHAR(500) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (review_id) REFERENCES reviews(id) ON DELETE CASCADE
);
```

**操作日志表 (admin_logs)**
```sql
CREATE TABLE admin_logs (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    admin_id VARCHAR(36) NOT NULL,
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50) NOT NULL,
    resource_id VARCHAR(36),
    details JSON,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (admin_id) REFERENCES admin_users(id)
);
```

### 6.3 数据迁移脚本

**初始化分类数据**
```sql
INSERT INTO categories (id, name, description, image_url) VALUES
('hetian', '和田玉', '温润如脂，君子之石', 'https://trae-api-us.mchost.guru/api/ide/v1/text_to_image?prompt=white%20hetian%20jade%20carved%20pendant%20with%20traditional%20Chinese%20design&image_size=square'),
('jadeite', '翡翠', '翠绿欲滴，富贵吉祥', 'https://trae-api-us.mchost.guru/api/ide/v1/text_to_image?prompt=green%20jadeite%20bracelet%20with%20natural%20patterns%20and%20high%20transparency&image_size=square'),
('agate', '玛瑙', '色彩斑斓，护身辟邪', 'https://trae-api-us.mchost.guru/api/ide/v1/text_to_image?prompt=colorful%20agate%20beads%20necklace%20with%20natural%20banding%20patterns&image_size=square'),
('crystal', '水晶', '晶莹剔透，净化心灵', 'https://trae-api-us.mchost.guru/api/ide/v1/text_to_image?prompt=clear%20crystal%20sphere%20with%20rainbow%20reflections%20on%20elegant%20stand&image_size=square');
```

**初始化管理员用户**
```sql
INSERT INTO admin_users (id, username, password_hash, name, email, role) VALUES
('admin-001', 'admin', '$2b$10$hash_password_here', '系统管理员', 'admin@jadeshopping.com', 'super_admin'),
('admin-002', 'operator', '$2b$10$hash_password_here', '运营专员', 'operator@jadeshopping.com', 'operator');
```

**初始化权限数据**
```sql
INSERT INTO permissions (code, name, description, module) VALUES
('product.view', '查看商品', '查看商品列表和详情', 'product'),
('product.create', '创建商品', '添加新商品', 'product'),
('product.update', '更新商品', '编辑商品信息', 'product'),
('product.delete', '删除商品', '删除商品', 'product'),
('order.view', '查看订单', '查看订单列表和详情', 'order'),
('order.update', '更新订单', '修改订单状态', 'order'),
('user.view', '查看用户', '查看用户列表和详情', 'user'),
('user.update', '更新用户', '修改用户信息', 'user'),
('analytics.view', '查看数据', '查看统计报表', 'analytics'),
('system.manage', '系统管理', '系统配置和管理', 'system');
```

## 7. 部署架构

### 7.1 Docker配置

**docker-compose.yml**
```yaml
version: '3.8'

services:
  # MySQL数据库
  mysql:
    image: mysql:8.0
    container_name: jadeshopping_mysql
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: jadeshopping
      MYSQL_USER: jade_user
      MYSQL_PASSWORD: jade_password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql

  # Redis缓存
  redis:
    image: redis:7.0-alpine
    container_name: jadeshopping_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # 后端API服务
  backend:
    build: ./backend
    container_name: jadeshopping_backend
    environment:
      NODE_ENV: production
      DATABASE_URL: mysql://jade_user:jade_password@mysql:3306/jadeshopping
      REDIS_URL: redis://redis:6379
      JWT_SECRET: your_jwt_secret_here
    ports:
      - "3001:3001"
    depends_on:
      - mysql
      - redis
    volumes:
      - ./uploads:/app/uploads

  # 前端应用
  frontend:
    build: ./frontend
    container_name: jadeshopping_frontend
    ports:
      - "3000:3000"
    depends_on:
      - backend

  # 后台管理系统
  admin:
    build: ./admin
    container_name: jadeshopping_admin
    ports:
      - "3002:3002"
    depends_on:
      - backend

  # Nginx反向代理
  nginx:
    image: nginx:alpine
    container_name: jadeshopping_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - frontend
      - admin
      - backend

volumes:
  mysql_data:
  redis_data:
```

### 7.2 环境配置

**后端环境变量 (.env)**
```env
# 数据库配置
DATABASE_URL="mysql://jade_user:jade_password@localhost:3306/jadeshopping"

# Redis配置
REDIS_URL="redis://localhost:6379"

# JWT配置
JWT_SECRET="your_super_secret_jwt_key_here"
JWT_EXPIRES_IN="7d"

# 文件上传配置
UPLOAD_PATH="./uploads"
MAX_FILE_SIZE="10MB"

# 邮件配置
SMTP_HOST="smtp.example.com"
SMTP_PORT="587"
SMTP_USER="noreply@jadeshopping.com"
SMTP_PASS="email_password"

# 支付配置
ALIPAY_APP_ID="your_alipay_app_id"
ALIPAY_PRIVATE_KEY="your_alipay_private_key"
WECHAT_APP_ID="your_wechat_app_id"
WECHAT_APP_SECRET="your_wechat_app_secret"
```

### 7.3 Nginx配置

```nginx
upstream backend {
    server backend:3001;
}

upstream frontend {
    server frontend:3000;
}

upstream admin {
    server admin:3002;
}

server {
    listen 80;
    server_name jadeshopping.com www.jadeshopping.com;
    
    # 前端应用
    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 后台管理系统
    location /admin {
        proxy_pass http://admin;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # API接口
    location /api {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 静态文件
    location /uploads {
        alias /var/www/uploads;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

## 8. 安全架构

### 8.1 认证授权

- **JWT Token认证**：使用JSON Web Token进行用户身份验证
- **角色权限控制**：基于RBAC模型的权限管理系统
- **API访问控制**：所有API接口都需要有效的认证令牌
- **会话管理**：Token过期自动刷新机制

### 8.2 数据安全

- **密码加密**：使用bcrypt进行密码哈希存储
- **数据传输加密**：HTTPS协议保护数据传输安全
- **SQL注入防护**：使用Prisma ORM防止SQL注入攻击
- **XSS防护**：输入验证和输出编码防止跨站脚本攻击

### 8.3 操作审计

- **操作日志记录**：记录所有管理员操作行为
- **登录日志**：记录登录时间、IP地址、设备信息
- **数据变更追踪**：记录重要数据的变更历史
- **异常行为监控**：监控异常登录和操作行为

## 9. 监控和维护

### 9.1 系统监控

- **应用性能监控**：监控API响应时间和错误率
- **数据库监控**：监控数据库连接数和查询性能
- **服务器监控**：监控CPU、内存、磁盘使用情况
- **日志收集**：集中收集和分析应用日志

### 9.2 备份策略

- **数据库备份**：每日自动备份数据库
- **文件备份**：定期备份上传的文件资源
- **配置备份**：备份系统配置和部署脚本
- **灾难恢复**：制定灾难恢复预案和流程